{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14/dist/handsontable.full.min.css">
<style>
    .bulk-edit-container {
        padding: 20px;
    }
    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #417690;
    }
    .tab {
        padding: 12px 24px;
        background: #f0f0f0;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-radius: 4px 4px 0 0;
        margin-right: 2px;
    }
    .tab.active {
        background: #417690;
        color: white;
    }
    .tab:hover:not(.active) {
        background: #ddd;
    }
    .tab-content {
        display: none;
        padding: 20px;
        background: #fff;
        border: 1px solid #ddd;
        border-top: none;
    }
    .tab-content.active {
        display: block;
    }
    .controls {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .controls select, .controls input, .controls button {
        padding: 8px 12px;
        font-size: 14px;
    }
    .controls select {
        min-width: 200px;
    }
    .controls button {
        background: #417690;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .controls button:hover {
        background: #205067;
    }
    .controls button.secondary {
        background: #666;
    }
    .controls button.success {
        background: #28a745;
    }
    .controls button.danger {
        background: #dc3545;
    }
    .controls button.warning {
        background: #ffc107;
        color: #333;
    }
    .grid-container {
        width: 100%;
        height: calc(100vh - 400px);
        min-height: 400px;
        overflow: hidden;
    }
    .status-bar {
        margin-top: 10px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 13px;
    }
    .status-bar .success { color: #28a745; }
    .status-bar .error { color: #dc3545; }
    .status-bar .info { color: #17a2b8; }
    .status-bar .warning { color: #ffc107; }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        color: #333;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 500px;
        max-width: 90%;
    }
    .modal-content h3 {
        margin-top: 0;
        color: #333;
    }
    .modal-content label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
    }
    .modal-content select, .modal-content textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0 10px 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #333;
        background-color: #fff;
    }
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="email"],
    .modal-content input[type="password"],
    .modal-content input[type="search"] {
        width: 100%;
        padding: 8px;
        margin: 5px 0 10px 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #333;
        background-color: #fff;
    }
    .modal-content input[type="checkbox"],
    .modal-content input[type="radio"] {
        width: auto;
        margin: 0;
        flex-shrink: 0;
    }
    .modal-content p {
        color: #666;
    }
    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }
    
    .help-text {
        background: #e7f3ff;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 13px;
        line-height: 1.5;
    }
    .help-text strong {
        color: #417690;
    }
    
    /* New row indicator */
    .new-row {
        background-color: #d4edda !important;
    }
    
    /* Option row (child of attribute type) */
    .option-row {
        background-color: #f8f9fa !important;
    }
    .option-row td {
        color: #666 !important;
        font-size: 12px !important;
    }
    
    /* Image upload area */
    .image-upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f9f9f9;
    }
    .image-upload-area:hover, .image-upload-area.dragover {
        border-color: #417690;
        background: #e7f3ff;
    }
    .image-upload-area p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }
    
    /* Image gallery */
    .image-item {
        position: relative;
        width: 100px;
        height: 100px;
        border: 2px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
        cursor: pointer;
    }
    .image-item.primary {
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
    }
    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .image-item .image-actions {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: space-around;
        padding: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .image-item:hover .image-actions {
        opacity: 1;
    }
    .image-item .image-actions button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 6px;
    }
    .image-item .image-actions button:hover {
        transform: scale(1.2);
    }
    .image-item .primary-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        background: #28a745;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    /* Categories modal styles */
    .category-item {
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .category-item:hover {
        background-color: #f5f5f5;
    }
    .category-item.selected {
        background-color: #e3f2fd;
    }
    .category-badge {
        display: inline-flex;
        align-items: center;
        background: #e3f2fd;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin: 2px;
    }
    .category-badge button {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        margin-left: 5px;
        font-size: 14px;
        padding: 0 2px;
    }
    .category-badge button:hover {
        color: #dc3545;
    }
    
    /* Category hierarchy styles */
    .category-toggle {
        cursor: pointer;
        display: inline-block;
        width: 16px;
        text-align: center;
        font-size: 10px;
        color: #666;
        user-select: none;
    }
    .category-toggle:hover {
        color: #417690;
    }
    .category-name-cell {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .category-indent {
        display: inline-block;
        width: 20px;
    }
    .category-row-collapsed {
        display: none !important;
    }
    .category-level-0 { font-weight: bold; }
    .category-level-1 { color: #444; }
    .category-level-2 { color: #666; }
    .category-level-3 { color: #888; font-style: italic; }
</style>
{% endblock %}

{% block content %}
<div class="bulk-edit-container">
    <h1>Gerenciamento de Produtos e Variantes</h1>
    
    <div class="tabs">
        <button class="tab active" onclick="switchTab('products')">üì¶ Produtos</button>
        <button class="tab" onclick="switchTab('variants')">üè∑Ô∏è Variantes</button>
        <button class="tab" onclick="switchTab('groups')">üìÅ Grupos</button>
        <button class="tab" onclick="switchTab('attributes')">‚öôÔ∏è Atributos</button>
        <button class="tab" onclick="switchTab('categories')">üìÇ Categorias</button>
    </div>
    
    <!-- TAB: PRODUTOS -->
    <div id="tab-products" class="tab-content active">
        <div class="help-text">
            <strong>Dica:</strong> Adicione novas linhas clicando com bot√£o direito ‚Üí "Inserir linha abaixo". 
            Use <strong>Ctrl+C/Ctrl+V</strong> para copiar/colar. C√©lulas verdes s√£o novas linhas n√£o salvas.
        </div>
        
        <div class="controls">
            <button type="button" onclick="addProductRow()">‚ûï Nova Linha</button>
            <button type="button" class="success" onclick="saveProducts()">üíæ Salvar Produtos</button>
            <button type="button" class="secondary" onclick="loadProducts()">üîÑ Recarregar</button>
        </div>
        
        <div id="products-grid" class="grid-container"></div>
        <div class="status-bar" id="products-status">
            <span class="info">Carregando produtos...</span>
        </div>
    </div>
    
    <!-- TAB: VARIANTES -->
    <div id="tab-variants" class="tab-content">
        <div class="help-text">
            <strong>Dica:</strong> Selecione um produto para ver suas variantes. 
            <strong>Duplique linhas</strong> clicando com bot√£o direito ‚Üí "Duplicar linha". 
            Edite SKU e atributos para criar novas variantes.
        </div>
        
        <div class="controls">
            <label for="variant-product-select">Produto:</label>
            <select id="variant-product-select" onchange="loadVariants()">
                <option value="">-- Selecione um produto --</option>
                {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
                {% endfor %}
            </select>
            
            <button type="button" onclick="addVariantRow()">‚ûï Nova Variante</button>
            <button type="button" onclick="duplicateVariantRows()">üìã Duplicar Selecionadas</button>
            <button type="button" class="success" onclick="saveVariants()">üíæ Salvar Variantes</button>
            <button type="button" class="warning" onclick="openGroupModal()">üìÅ Adicionar a Grupo</button>
        </div>
        
        <div id="variants-grid" class="grid-container"></div>
        <div class="status-bar" id="variants-status">
            <span class="info">Selecione um produto para carregar suas variantes.</span>
        </div>
    </div>
    
    <!-- TAB: GRUPOS -->
    <div id="tab-groups" class="tab-content">
        <div class="help-text">
            <strong>Grupos:</strong> Gerencie os grupos de variantes para cada produto. 
            Grupos permitem agrupar variantes por caracter√≠sticas semelhantes para exibi√ß√£o na loja.
        </div>
        
        <div class="controls">
            <label for="group-product-select">Produto:</label>
            <select id="group-product-select" onchange="loadGroups()">
                <option value="">-- Selecione um produto --</option>
                {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
                {% endfor %}
            </select>
            
            <button type="button" onclick="addGroupRow()">‚ûï Novo Grupo</button>
            <button type="button" class="success" onclick="saveGroups()">üíæ Salvar Grupos</button>
        </div>
        
        <div id="groups-grid" class="grid-container"></div>
        <div class="status-bar" id="groups-status">
            <span class="info">Selecione um produto para gerenciar seus grupos.</span>
        </div>
    </div>
    
    <!-- TAB: ATRIBUTOS -->
    <div id="tab-attributes" class="tab-content">
        <div class="help-text">
            <strong>Tipos de Atributos:</strong> Gerencie os tipos de atributos dispon√≠veis (Cor, Tamanho, Comprimento, etc).
            <br>As op√ß√µes de cada atributo s√£o criadas automaticamente ao salvar produtos na aba Produtos (via JSON de atributos).
        </div>
        
        <div class="controls">
            <button type="button" onclick="openNewAttrTypeModal()">‚ûï Novo Tipo de Atributo</button>
            <button type="button" class="success" onclick="saveAttributeTypes()">üíæ Salvar Tipos</button>
        </div>
        
        <div id="attributes-grid" class="grid-container"></div>
        <div class="status-bar" id="attributes-status">
            <span class="info">Gerencie os tipos de atributos.</span>
        </div>
    </div>
    
    <!-- TAB: CATEGORIAS -->
    <div id="tab-categories" class="tab-content">
        <div class="help-text">
            <strong>Categorias:</strong> Gerencie categorias hier√°rquicas. Clique em "‚ñ∂/‚ñº" para expandir/colapsar. Clique em "(X produtos)" para gerenciar produtos.
        </div>
        
        <div class="controls">
            <button type="button" onclick="addCategoryRow()">‚ûï Nova Categoria</button>
            <button type="button" class="success" onclick="saveCategories()">üíæ Salvar Categorias</button>
            <button type="button" class="secondary" onclick="loadCategoriesGrid()">üîÑ Recarregar</button>
            <span style="margin-left: 20px; border-left: 1px solid #ccc; padding-left: 15px;">
                <button type="button" class="secondary" onclick="expandAllCategories()">üìÇ Expandir Tudo</button>
                <button type="button" class="secondary" onclick="collapseAllCategories()">üìÅ Colapsar Tudo</button>
            </span>
        </div>
        
        <div id="categories-grid" class="grid-container"></div>
        <div class="status-bar" id="categories-status">
            <span class="info">Carregando categorias...</span>
        </div>
    </div>
</div>

<!-- Modal: Attribute Type Products (Grid) -->
<div id="attr-type-products-modal" class="modal">
    <div class="modal-content" style="max-width: 95%; width: 1200px; max-height: 85vh; display: flex; flex-direction: column;">
        <h3>üè∑Ô∏è Produtos com atributo: <span id="attr-type-products-name"></span></h3>
        
        <div id="attr-type-products-grid" style="flex: 1; min-height: 300px; overflow: auto;"></div>
        
        <div class="status-bar" id="attr-type-products-status" style="margin-top: 10px;">
            <span class="info">Carregando...</span>
        </div>
        
        <div class="modal-buttons" style="margin-top: 15px;">
            <button type="button" class="secondary" onclick="closeAttrTypeProductsModal()">Fechar</button>
            <button type="button" onclick="goToProductsTab()">‚ÜóÔ∏è Abrir na Tab Produtos</button>
        </div>
    </div>
</div>

<!-- Modal: Attribute Options Editor (Grid) -->
<div id="attr-options-modal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;">
        <h3>‚öôÔ∏è Op√ß√µes do atributo: <span id="attr-options-type-name"></span></h3>
        
        <div class="help-text" style="margin-bottom: 10px;">
            Edite as op√ß√µes deste tipo de atributo. O <strong>Grupo de Filtro</strong> serve para agrupar valores similares nos filtros do site.
        </div>
        
        <div id="attr-options-grid" style="flex: 1; min-height: 250px; overflow: auto;"></div>
        
        <div class="status-bar" id="attr-options-status" style="margin-top: 10px;">
            <span class="info">Carregando...</span>
        </div>
        
        <div class="modal-buttons" style="margin-top: 15px;">
            <button type="button" class="secondary" onclick="closeAttrOptionsModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveAttrOptions()">üíæ Salvar Op√ß√µes</button>
        </div>
    </div>
</div>

<!-- Modal: Category Products Manager -->
<div id="category-products-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; display: flex; flex-direction: column;">
        <h3>üìÇ Produtos da Categoria: <span id="cat-products-category-name"></span></h3>
        
        <!-- Search -->
        <div style="margin-bottom: 15px;">
            <input type="text" id="cat-products-search" placeholder="üîç Buscar produtos..." 
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                   oninput="filterCategoryProducts(this.value)">
        </div>
        
        <!-- Products list with checkboxes -->
        <div style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 4px; max-height: 400px;">
            <div id="cat-products-list" style="padding: 0;">
                <!-- Products will be inserted here -->
            </div>
        </div>
        
        <!-- Stats -->
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <span id="cat-products-stats"></span>
        </div>
        
        <div class="modal-buttons" style="margin-top: 15px;">
            <button type="button" class="secondary" onclick="closeCategoryProductsModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveCategoryProducts()">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal: Add to Group / Create New Group -->
<div id="group-modal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <h3>üìÅ Adicionar Variantes a um Grupo</h3>
        <p id="selected-variants-info" style="font-size: 13px; color: #666;"></p>
        
        <div style="margin: 15px 0;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="radio" name="group-action" value="existing" checked onchange="toggleGroupForm()">
                <span>Adicionar a grupo existente</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 8px;">
                <input type="radio" name="group-action" value="new" onchange="toggleGroupForm()">
                <span>Criar novo grupo com estas variantes</span>
            </label>
        </div>
        
        <!-- Existing Group Form -->
        <div id="existing-group-form">
            <label>Grupo:</label>
            <select id="modal-group-select">
                <option value="">-- Selecione um grupo --</option>
                {% for group in variant_groups %}
                <option value="{{ group.id }}" data-product="{{ group.product_id }}">
                    {{ group.product.name }} - {{ group.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- New Group Form -->
        <div id="new-group-form" style="display: none;">
            <label>Nome do Grupo: *</label>
            <input type="text" id="new-group-name" placeholder="Ex: Linha Modelo X Colorida (N√∫mero 5)">
            
            <label>Slug (identificador):</label>
            <input type="text" id="new-group-slug" placeholder="Gerado automaticamente se vazio">
            
            <label>Descri√ß√£o:</label>
            <textarea id="new-group-description" rows="3" placeholder="Descri√ß√£o do grupo para SEO e exibi√ß√£o"></textarea>
            
            <div id="new-group-image-preview" style="margin: 10px 0; display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 13px; color: #666;">Imagem: Ser√° usada a imagem da primeira variante do grupo</span>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeGroupModal()">Cancelar</button>
            <button type="button" class="success" onclick="submitGroupAction()">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal: New Attribute Type -->
<div id="attr-type-modal" class="modal">
    <div class="modal-content">
        <h3>Novo Tipo de Atributo</h3>
        <label>Nome:</label>
        <input type="text" id="new-attr-type-name" placeholder="Ex: Cor, Tamanho, Material">
        <label>Slug (identificador):</label>
        <input type="text" id="new-attr-type-slug" placeholder="Ex: cor, tamanho, material">
        <label>Tipo de Dado:</label>
        <select id="new-attr-type-datatype">
            <option value="text">Texto</option>
            <option value="number">N√∫mero</option>
            <option value="decimal">Decimal</option>
            <option value="color">Cor (Hex)</option>
        </select>
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeAttrTypeModal()">Cancelar</button>
            <button type="button" class="success" onclick="createAttributeType()">Criar</button>
        </div>
    </div>
</div>

<!-- Modal: Image Manager -->
<div id="image-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <h3>üì∑ Imagens da Variante: <span id="image-modal-sku"></span></h3>
        
        <div class="image-upload-area" id="image-drop-zone">
            <p>üìÅ Arraste imagens aqui ou clique para selecionar</p>
            <input type="file" id="image-file-input" multiple accept="image/*" style="display: none;">
        </div>
        
        <div id="image-gallery" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; min-height: 100px;">
            <!-- Images will be loaded here -->
        </div>
        
        <div id="image-upload-status" style="margin-top: 10px; font-size: 13px;"></div>
        
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeImageModal()">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal: Edit Attributes JSON -->
<div id="json-attributes-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3>‚öôÔ∏è Editar Atributos do Produto: <span id="json-attr-product-name"></span></h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Defina os tipos de atributos e seus valores poss√≠veis. Ex: Cor com valores [azul, vermelho, verde]
        </p>
        <div style="flex: 1; overflow: auto; min-height: 200px;">
            <div id="json-attributes-grid" style="width: 100%; height: 250px;"></div>
        </div>
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeJsonAttributesModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveJsonAttributes()">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal: Edit Variants JSON -->
<div id="json-variants-modal" class="modal">
    <div class="modal-content" style="max-width: 95vw; max-height: 85vh; display: flex; flex-direction: column;">
        <h3>üè∑Ô∏è Editar Variantes do Produto: <span id="json-var-product-name"></span></h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Edite as variantes. As colunas de atributos s√£o geradas automaticamente a partir dos atributos definidos.
        </p>
        <div style="flex: 1; overflow: auto; min-height: 300px;">
            <div id="json-variants-grid" style="width: 100%; height: 400px;"></div>
        </div>
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeJsonVariantsModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveJsonVariants()">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal: Edit Groups JSON -->
<div id="json-groups-modal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3>üìÅ Editar Grupos do Produto: <span id="json-grp-product-name"></span></h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Defina grupos de variantes. Na coluna "variantes", liste os SKUs separados por v√≠rgula.
        </p>
        <div style="flex: 1; overflow: auto; min-height: 200px;">
            <div id="json-groups-grid" style="width: 100%; height: 250px;"></div>
        </div>
        <div class="modal-buttons">
            <button type="button" class="secondary" onclick="closeJsonGroupsModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveJsonGroups()">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal: Categories Multi-select -->
<div id="categories-modal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3>üìÇ Categorias do Produto: <span id="cat-product-name"></span></h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Selecione uma ou mais categorias para o produto. Use a busca para filtrar.
        </p>
        
        <!-- Search input -->
        <div style="margin-bottom: 10px; flex-shrink: 0;">
            <input type="text" id="category-search" placeholder="üîç Buscar categorias..." 
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                   oninput="searchCategories(this.value)">
        </div>
        
        <!-- Expand/Collapse buttons -->
        <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-shrink: 0;">
            <button type="button" class="secondary" onclick="expandAllModalCategories()" style="padding: 6px 12px; font-size: 12px;">üìÇ Expandir Tudo</button>
            <button type="button" class="secondary" onclick="collapseAllModalCategories()" style="padding: 6px 12px; font-size: 12px;">üìÅ Colapsar Tudo</button>
        </div>
        
        <!-- Selected categories -->
        <div id="selected-categories" style="margin-bottom: 10px; flex-shrink: 0;">
            <label style="font-weight: 500; margin-bottom: 5px; display: block;">Selecionadas:</label>
            <div id="selected-cats-container" style="display: flex; flex-wrap: wrap; gap: 5px; min-height: 28px; padding: 5px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                <!-- Selected category badges will be inserted here -->
            </div>
        </div>
        
        <!-- Available categories -->
        <div style="flex: 1; overflow: auto; min-height: 150px; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
            <div id="categories-list" style="padding: 0; background: #fff;">
                <!-- Category checkboxes will be inserted here -->
            </div>
        </div>
        
        <div class="modal-buttons" style="margin-top: 15px; flex-shrink: 0;">
            <button type="button" class="secondary" onclick="closeCategoriesModal()">Cancelar</button>
            <button type="button" class="success" onclick="saveProductCategories()">Salvar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/handsontable@14/dist/handsontable.full.min.js"></script>
<script>
    const csrfToken = '{{ csrf_token }}';
    let productsHot = null;
    let variantsHot = null;
    let attributesHot = null;
    let categoriesHot = null;
    let currentProductId = null;
    let currentAttrTypeId = null;
    let currentImageVariantId = null;
    
    // JSON editor instances
    let jsonAttributesHot = null;
    let jsonVariantsHot = null;
    let jsonGroupsHot = null;
    let jsonEditingRow = null;  // Row index being edited in products table
    
    // Track new rows
    let newProductRows = new Set();
    let newVariantRows = new Set();
    let newAttrOptionRows = new Set();
    let newCategoryRows = new Set();
    
    // =============================================================================
    // TAB SWITCHING
    // =============================================================================
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Load data for tab if needed
        if (tabName === 'products' && !productsHot) {
            loadProducts();
        }
        if (tabName === 'categories' && !categoriesHot) {
            loadCategoriesGrid();
        }
        if (tabName === 'attributes' && !attributesHot) {
            loadAttributeTypes();
        }
    }
    
    function setStatus(elementId, message, type = 'info') {
        document.getElementById(elementId).innerHTML = `<span class="${type}">${message}</span>`;
    }
    
    // =============================================================================
    // PRODUCTS TAB
    // =============================================================================
    
    function loadProducts() {
        setStatus('products-status', 'Carregando produtos...', 'info');
        
        fetch('{% url "catalog:bulk_products_data" %}')
            .then(response => response.json())
            .then(data => {
                initProductsGrid(data);
                setStatus('products-status', `${data.data.length} produtos carregados.`, 'success');
            })
            .catch(error => {
                setStatus('products-status', `Erro: ${error}`, 'error');
            });
    }
    
    function initProductsGrid(jsonData) {
        const container = document.getElementById('products-grid');
        
        if (productsHot) {
            productsHot.destroy();
        }
        
        newProductRows.clear();
        
        // Custom renderer for thumbnail
        function thumbnailRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            td.innerHTML = '';
            if (value) {
                const img = document.createElement('img');
                img.src = value;
                img.style.width = '40px';
                img.style.height = '40px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                td.appendChild(img);
            } else {
                td.innerHTML = '<span style="color:#999;font-size:11px;">Sem imagem</span>';
            }
            td.style.textAlign = 'center';
        }
        
        // Custom renderer for links
        function linksRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const rowData = instance.getSourceDataAtRow(row);
            if (!rowData || !rowData.id) {
                td.innerHTML = '-';
                return;
            }
            
            const productId = rowData.id;
            td.innerHTML = `
                <div style="display:flex;gap:8px;justify-content:center;">
                    <a href="#" onclick="viewProductVariants(${productId}); return false;" 
                       title="Ver variantes" style="color:#417690;text-decoration:none;">
                        üè∑Ô∏è <span style="font-size:11px;">${rowData.variant_count || 0}</span>
                    </a>
                    <a href="#" onclick="viewProductGroups(${productId}); return false;" 
                       title="Ver grupos" style="color:#417690;text-decoration:none;">
                        üìÅ <span style="font-size:11px;">${rowData.group_count || 0}</span>
                    </a>
                    <a href="#" onclick="viewProductAttributes(${productId}); return false;" 
                       title="Ver atributos" style="color:#417690;text-decoration:none;">
                        ‚öôÔ∏è <span style="font-size:11px;">${rowData.attr_types_count || 0}</span>
                    </a>
                </div>
            `;
        }
        
        // Renderer for variant-only fields (show only if not has_variants)
        function variantFieldRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.has_variants) {
                td.innerHTML = '<span style="color:#999;font-size:11px;font-style:italic;">M√∫ltiplas</span>';
                td.style.backgroundColor = '#f5f5f5';
                cellProperties.readOnly = true;
            } else {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
                td.style.backgroundColor = '';
            }
        }
        
        function variantCostPriceRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.has_variants && rowData.price_stats) {
                const stats = rowData.price_stats;
                if (stats.cost_min !== null) {
                    td.innerHTML = `
                        <div style="font-size:10px;line-height:1.3;color:#666;">
                            <span title="M√≠nimo">‚Üì${stats.cost_min.toFixed(2)}</span>
                            <span title="M√°ximo">‚Üë${stats.cost_max.toFixed(2)}</span>
                            <br><span title="M√©dia" style="color:#417690;">Œº${stats.cost_avg.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    td.innerHTML = '<span style="color:#999;font-size:11px;">-</span>';
                }
                td.style.backgroundColor = '#f5f5f5';
                td.style.textAlign = 'center';
                cellProperties.readOnly = true;
            } else {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                td.style.backgroundColor = '';
            }
        }
        
        function variantSellPriceRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.has_variants && rowData.price_stats) {
                const stats = rowData.price_stats;
                if (stats.sell_min !== null) {
                    td.innerHTML = `
                        <div style="font-size:10px;line-height:1.3;color:#666;">
                            <span title="M√≠nimo">‚Üì${stats.sell_min.toFixed(2)}</span>
                            <span title="M√°ximo">‚Üë${stats.sell_max.toFixed(2)}</span>
                            <br><span title="M√©dia" style="color:#417690;">Œº${stats.sell_avg.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    td.innerHTML = '<span style="color:#999;font-size:11px;">-</span>';
                }
                td.style.backgroundColor = '#f5f5f5';
                td.style.textAlign = 'center';
                cellProperties.readOnly = true;
            } else {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                td.style.backgroundColor = '';
            }
        }
        
        function variantStockRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.has_variants && rowData.stock_stats) {
                const stats = rowData.stock_stats;
                td.innerHTML = `
                    <div style="font-size:10px;line-height:1.3;color:#666;">
                        <span title="M√≠nimo">‚Üì${stats.min}</span>
                        <span title="M√°ximo">‚Üë${stats.max}</span>
                        <br><span title="M√©dia">Œº${stats.avg}</span>
                        <span title="Total" style="color:#28a745;font-weight:bold;">Œ£${stats.total}</span>
                    </div>
                `;
                td.style.backgroundColor = '#f5f5f5';
                td.style.textAlign = 'center';
                cellProperties.readOnly = true;
            } else {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                td.style.backgroundColor = '';
            }
        }
        
        // JSON renderers for attributes, variants, groups - clickable to edit
        function jsonAttributesRenderer(instance, td, row, col, prop, value, cellProperties) {
            td.style.fontSize = '11px';
            td.style.whiteSpace = 'nowrap';
            td.style.overflow = 'hidden';
            td.style.textOverflow = 'ellipsis';
            td.style.cursor = 'pointer';
            
            if (!value || value.length === 0) {
                td.innerHTML = '<span style="color:#666;text-decoration:underline;">+ Adicionar</span>';
            } else {
                // Show compact view: "Cor(3) Tamanho(4) ..."
                const summary = value.map(attr => 
                    `<span style="background:#e3f2fd;padding:1px 4px;border-radius:3px;margin-right:3px;">${attr.atributo}(${attr.valores.length})</span>`
                ).join('');
                td.innerHTML = summary;
            }
            
            td.onclick = function(e) {
                e.stopPropagation();
                openJsonAttributesModal(row);
            };
        }
        
        function jsonVariantsRenderer(instance, td, row, col, prop, value, cellProperties) {
            td.style.fontSize = '11px';
            td.style.whiteSpace = 'nowrap';
            td.style.overflow = 'hidden';
            td.style.textOverflow = 'ellipsis';
            td.style.cursor = 'pointer';
            
            if (!value || value.length === 0) {
                td.innerHTML = '<span style="color:#666;text-decoration:underline;">+ Adicionar</span>';
            } else {
                // Show count and first few SKUs
                const skus = value.slice(0, 3).map(v => v.sku).join(', ');
                const more = value.length > 3 ? ` +${value.length - 3}` : '';
                td.innerHTML = `<span style="color:#417690;">${value.length}:</span> ${skus}${more}`;
            }
            
            td.onclick = function(e) {
                e.stopPropagation();
                openJsonVariantsModal(row);
            };
        }
        
        function jsonGroupsRenderer(instance, td, row, col, prop, value, cellProperties) {
            td.style.fontSize = '11px';
            td.style.whiteSpace = 'nowrap';
            td.style.overflow = 'hidden';
            td.style.textOverflow = 'ellipsis';
            td.style.cursor = 'pointer';
            
            if (!value || value.length === 0) {
                td.innerHTML = '<span style="color:#666;text-decoration:underline;">+ Adicionar</span>';
            } else {
                // Show group names
                const names = value.map(g => 
                    `<span style="background:#fff3e0;padding:1px 4px;border-radius:3px;margin-right:3px;">${g.nome}</span>`
                ).join('');
                td.innerHTML = names;
            }
            
            td.onclick = function(e) {
                e.stopPropagation();
                openJsonGroupsModal(row);
            };
        }
        
        function categoriesRenderer(instance, td, row, col, prop, value, cellProperties) {
            td.style.fontSize = '11px';
            td.style.whiteSpace = 'nowrap';
            td.style.overflow = 'hidden';
            td.style.textOverflow = 'ellipsis';
            td.style.cursor = 'pointer';
            
            if (!value || !Array.isArray(value) || value.length === 0) {
                td.innerHTML = '<span style="color:#666;text-decoration:underline;">+ Categorias</span>';
            } else {
                // Show category names with different colors for hierarchy
                const badges = value.map(c => {
                    // Check if category has a parent (is a subcategory)
                    const isSubcategory = c.pai || (c.full_path && c.full_path.includes(' > '));
                    const bgColor = isSubcategory ? '#e3f2fd' : '#e8f5e9';  // Blue for subcategory, green for root
                    const displayName = c.nome || c.name || 'Sem nome';
                    const tooltipPath = c.full_path || displayName;
                    return `<span style="background:${bgColor};padding:1px 4px;border-radius:3px;margin-right:3px;display:inline-block;" title="${tooltipPath}">${displayName}</span>`;
                }).join('');
                td.innerHTML = badges;
            }
            
            td.onclick = function(e) {
                e.stopPropagation();
                openCategoriesModal(row);
            };
        }
        
        productsHot = new Handsontable(container, {
            data: jsonData.data,
            colHeaders: ['', 'ID', 'Nome', 'Slug', 'Descri√ß√£o', 'SKU', 'Pre√ßo Custo', 'Pre√ßo Venda', 'Estoque', 'Ativo', 'Categorias', 'A√ß√µes', 'Atributos', 'Variantes', 'Grupos', 'Criado em'],
            columns: [
                {data: 'thumbnail_url', renderer: thumbnailRenderer, readOnly: true, width: 60},
                {data: 'id', readOnly: true, width: 50},
                {data: 'name', width: 180},
                {data: 'slug', width: 130},
                {data: 'description', width: 200},
                {data: 'sku', width: 100, renderer: variantFieldRenderer},
                {data: 'cost_price', type: 'numeric', numericFormat: {pattern: '0,0.00'}, width: 100, renderer: variantCostPriceRenderer},
                {data: 'sell_price', type: 'numeric', numericFormat: {pattern: '0,0.00'}, width: 100, renderer: variantSellPriceRenderer},
                {data: 'stock_quantity', type: 'numeric', width: 80, renderer: variantStockRenderer},
                {data: 'is_active', type: 'checkbox', width: 60},
                {data: 'categories_json', renderer: categoriesRenderer, width: 180},
                {data: 'id', renderer: linksRenderer, readOnly: true, width: 130},
                {data: 'attributes_json', renderer: jsonAttributesRenderer, width: 150},
                {data: 'variants_json', renderer: jsonVariantsRenderer, width: 180},
                {data: 'groups_json', renderer: jsonGroupsRenderer, width: 150},
                {data: 'created_at', readOnly: true, width: 130},
            ],
            rowHeaders: true,
            contextMenu: {
                items: {
                    'row_above': {name: 'Inserir linha acima'},
                    'row_below': {name: 'Inserir linha abaixo'},
                    'remove_row': {name: 'Remover linha'},
                    'separator': Handsontable.plugins.ContextMenu.SEPARATOR,
                    'copy': {name: 'Copiar'},
                    'cut': {name: 'Recortar'},
                    'separator2': Handsontable.plugins.ContextMenu.SEPARATOR,
                    'undo': {name: 'Desfazer'},
                    'redo': {name: 'Refazer'},
                }
            },
            manualColumnResize: true,
            filters: true,
            dropdownMenu: true,
            multiColumnSorting: true,
            stretchH: 'all',
            height: '100%',
            copyPaste: true,
            fillHandle: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            afterCreateRow: function(index, amount) {
                for (let i = 0; i < amount; i++) {
                    newProductRows.add(index + i);
                    this.setDataAtRowProp(index + i, 'is_active', true);
                }
                this.render();
            },
            
            afterRemoveRow: function(index, amount) {
                // Update row indices
                const updated = new Set();
                newProductRows.forEach(row => {
                    if (row >= index + amount) {
                        updated.add(row - amount);
                    } else if (row < index) {
                        updated.add(row);
                    }
                });
                newProductRows = updated;
            },
            
            cells: function(row, col) {
                const cellProperties = {};
                if (newProductRows.has(row)) {
                    cellProperties.className = 'new-row';
                }
                return cellProperties;
            },
            
            // Handle copy for JSON columns - serialize to JSON string
            beforeCopy: function(data, coords) {
                const jsonColumns = ['attributes_json', 'variants_json', 'groups_json', 'categories_json'];
                
                coords.forEach((coord, index) => {
                    for (let row = coord.startRow; row <= coord.endRow; row++) {
                        for (let col = coord.startCol; col <= coord.endCol; col++) {
                            const prop = this.colToProp(col);
                            if (jsonColumns.includes(prop)) {
                                const rowIndex = row - coord.startRow;
                                const colIndex = col - coord.startCol;
                                const value = this.getDataAtCell(row, col);
                                if (value && typeof value === 'object') {
                                    data[rowIndex][colIndex] = JSON.stringify(value);
                                }
                            }
                        }
                    }
                });
            },
            
            // Handle paste for JSON columns - parse from JSON string
            beforePaste: function(data, coords) {
                const jsonColumns = ['attributes_json', 'variants_json', 'groups_json', 'categories_json'];
                
                coords.forEach((coord) => {
                    for (let row = 0; row < data.length; row++) {
                        for (let col = 0; col < data[row].length; col++) {
                            const targetCol = coord.startCol + col;
                            const prop = this.colToProp(targetCol);
                            
                            if (jsonColumns.includes(prop)) {
                                const value = data[row][col];
                                if (value && typeof value === 'string') {
                                    try {
                                        data[row][col] = JSON.parse(value);
                                    } catch (e) {
                                        // If not valid JSON, keep as is
                                        console.warn('Invalid JSON paste:', value);
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            // Allow editing JSON columns via paste
            beforeChange: function(changes, source) {
                if (source === 'CopyPaste.paste') {
                    const jsonColumns = ['attributes_json', 'variants_json', 'groups_json', 'categories_json'];
                    
                    changes.forEach((change, index) => {
                        const [row, prop, oldValue, newValue] = change;
                        if (jsonColumns.includes(prop) && typeof newValue === 'string') {
                            try {
                                changes[index][3] = JSON.parse(newValue);
                            } catch (e) {
                                // Keep as is if not valid JSON
                            }
                        }
                    });
                }
            }
        });
    }
    
    // Navigation functions for product links
    function viewProductVariants(productId) {
        // Switch to variants tab and select this product
        document.querySelector('.tab[onclick*="variants"]').click();
        setTimeout(() => {
            const select = document.getElementById('variant-product-select');
            select.value = productId;
            loadVariants();
        }, 100);
    }
    
    function viewProductGroups(productId) {
        // Open admin page for groups filtered by this product
        window.open(`/admin/catalog/variantgroup/?product__id__exact=${productId}`, '_blank');
    }
    
    function viewProductAttributes(productId) {
        // Switch to attributes tab
        document.querySelector('.tab[onclick*="attributes"]').click();
    }
    
    // =============================================================================
    // JSON EDITORS
    // =============================================================================
    
    function openJsonAttributesModal(row) {
        jsonEditingRow = row;
        const rowData = productsHot.getSourceDataAtRow(row);
        document.getElementById('json-attr-product-name').textContent = rowData.name || 'Novo Produto';
        
        // Get current attributes or empty array
        let attributes = rowData.attributes_json || [];
        
        // Convert to flat format for editing
        const flatData = attributes.map(attr => ({
            atributo: attr.atributo,
            valores: attr.valores.join(', ')
        }));
        
        // Add empty row if empty
        if (flatData.length === 0) {
            flatData.push({atributo: '', valores: ''});
        }
        
        const container = document.getElementById('json-attributes-grid');
        
        if (jsonAttributesHot) {
            jsonAttributesHot.destroy();
        }
        
        jsonAttributesHot = new Handsontable(container, {
            data: flatData,
            colHeaders: ['Atributo (ex: Cor)', 'Valores (separados por v√≠rgula)'],
            columns: [
                {data: 'atributo', width: 200},
                {data: 'valores', width: 400},
            ],
            rowHeaders: true,
            contextMenu: ['row_above', 'row_below', 'remove_row'],
            minSpareRows: 1,
            height: 250,
            stretchH: 'all',
            licenseKey: 'non-commercial-and-evaluation',
        });
        
        document.getElementById('json-attributes-modal').style.display = 'block';
    }
    
    function closeJsonAttributesModal() {
        document.getElementById('json-attributes-modal').style.display = 'none';
        if (jsonAttributesHot) {
            jsonAttributesHot.destroy();
            jsonAttributesHot = null;
        }
    }
    
    function saveJsonAttributes() {
        if (!jsonAttributesHot || jsonEditingRow === null) return;
        
        const data = jsonAttributesHot.getSourceData();
        const attributes = [];
        
        data.forEach(row => {
            if (row.atributo && row.atributo.trim()) {
                const valores = row.valores ? row.valores.split(',').map(v => v.trim()).filter(v => v) : [];
                if (valores.length > 0) {
                    attributes.push({
                        atributo: row.atributo.trim(),
                        valores: valores
                    });
                }
            }
        });
        
        // Update the products table - use empty array [] to signal deletion, not null
        productsHot.setDataAtRowProp(jsonEditingRow, 'attributes_json', attributes);
        
        closeJsonAttributesModal();
    }
    
    function openJsonVariantsModal(row) {
        jsonEditingRow = row;
        const rowData = productsHot.getSourceDataAtRow(row);
        document.getElementById('json-var-product-name').textContent = rowData.name || 'Novo Produto';
        
        // Get attributes to build dynamic columns
        const attributes = rowData.attributes_json || [];
        const variants = rowData.variants_json || [];
        
        // Build columns based on attributes
        const columns = [
            {data: 'sku', width: 120},
            {data: 'nome', width: 150},
        ];
        const colHeaders = ['SKU *', 'Nome'];
        
        // Add attribute columns
        attributes.forEach(attr => {
            const slug = attr.atributo.toLowerCase().replace(/\s+/g, '_');
            columns.push({
                data: slug,
                type: 'dropdown',
                source: attr.valores,
                width: 100
            });
            colHeaders.push(attr.atributo);
        });
        
        // Add price and stock columns
        columns.push(
            {data: 'preco_custo', type: 'numeric', numericFormat: {pattern: '0.00'}, width: 100},
            {data: 'preco_venda', type: 'numeric', numericFormat: {pattern: '0.00'}, width: 100},
            {data: 'estoque', type: 'numeric', width: 80}
        );
        colHeaders.push('Pre√ßo Custo', 'Pre√ßo Venda', 'Estoque');
        
        // Convert variants to flat format with slugified attribute keys
        const flatData = variants.map(v => {
            const row = {
                sku: v.sku || '',
                nome: v.nome || '',
                preco_custo: v.preco_custo,
                preco_venda: v.preco_venda,
                estoque: v.estoque || 0
            };
            // Copy attribute values using slugified keys
            attributes.forEach(attr => {
                const slug = attr.atributo.toLowerCase().replace(/\s+/g, '_');
                // Try to find value with original key or slug
                row[slug] = v[slug] || v[attr.atributo] || '';
            });
            return row;
        });
        
        // Add empty row if empty
        if (flatData.length === 0) {
            const emptyRow = {sku: '', nome: '', preco_custo: null, preco_venda: null, estoque: 0};
            attributes.forEach(attr => {
                const slug = attr.atributo.toLowerCase().replace(/\s+/g, '_');
                emptyRow[slug] = '';
            });
            flatData.push(emptyRow);
        }
        
        const container = document.getElementById('json-variants-grid');
        
        if (jsonVariantsHot) {
            jsonVariantsHot.destroy();
        }
        
        jsonVariantsHot = new Handsontable(container, {
            data: flatData,
            colHeaders: colHeaders,
            columns: columns,
            rowHeaders: true,
            contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'copy', 'cut'],
            minSpareRows: 1,
            height: 400,
            stretchH: 'all',
            copyPaste: true,
            fillHandle: true,
            licenseKey: 'non-commercial-and-evaluation',
        });
        
        // Store attribute info for saving
        jsonVariantsHot.attributeNames = attributes.map(a => ({
            name: a.atributo,
            slug: a.atributo.toLowerCase().replace(/\s+/g, '_')
        }));
        
        document.getElementById('json-variants-modal').style.display = 'block';
    }
    
    function closeJsonVariantsModal() {
        document.getElementById('json-variants-modal').style.display = 'none';
        if (jsonVariantsHot) {
            jsonVariantsHot.destroy();
            jsonVariantsHot = null;
        }
    }
    
    function saveJsonVariants() {
        if (!jsonVariantsHot || jsonEditingRow === null) return;
        
        const data = jsonVariantsHot.getSourceData();
        const attributeNames = jsonVariantsHot.attributeNames || [];
        const variants = [];
        
        data.forEach(row => {
            if (row.sku && row.sku.trim()) {
                const variant = {
                    sku: row.sku.trim(),
                    nome: row.nome || row.sku.trim(),
                    preco_custo: row.preco_custo,
                    preco_venda: row.preco_venda,
                    estoque: row.estoque || 0
                };
                // Add attribute values using slugified keys
                attributeNames.forEach(attr => {
                    if (row[attr.slug]) {
                        variant[attr.slug] = row[attr.slug];
                    }
                });
                variants.push(variant);
            }
        });
        
        // Update the products table
        productsHot.setDataAtRowProp(jsonEditingRow, 'variants_json', variants.length > 0 ? variants : null);
        
        closeJsonVariantsModal();
    }
    
    function openJsonGroupsModal(row) {
        jsonEditingRow = row;
        const rowData = productsHot.getSourceDataAtRow(row);
        document.getElementById('json-grp-product-name').textContent = rowData.name || 'Novo Produto';
        
        // Get current groups
        const groups = rowData.groups_json || [];
        
        // Convert to flat format
        const flatData = groups.map(g => ({
            nome: g.nome,
            slug: g.slug || '',
            descricao: g.descricao || '',
            variantes: g.variantes ? g.variantes.join(', ') : ''
        }));
        
        // Add empty row if empty
        if (flatData.length === 0) {
            flatData.push({nome: '', slug: '', descricao: '', variantes: ''});
        }
        
        const container = document.getElementById('json-groups-grid');
        
        if (jsonGroupsHot) {
            jsonGroupsHot.destroy();
        }
        
        jsonGroupsHot = new Handsontable(container, {
            data: flatData,
            colHeaders: ['Nome do Grupo *', 'Slug', 'Descri√ß√£o', 'SKUs das Variantes (separados por v√≠rgula)'],
            columns: [
                {data: 'nome', width: 180},
                {data: 'slug', width: 150},
                {data: 'descricao', width: 200},
                {data: 'variantes', width: 300},
            ],
            rowHeaders: true,
            contextMenu: ['row_above', 'row_below', 'remove_row'],
            minSpareRows: 1,
            height: 250,
            stretchH: 'all',
            licenseKey: 'non-commercial-and-evaluation',
        });
        
        document.getElementById('json-groups-modal').style.display = 'block';
    }
    
    function closeJsonGroupsModal() {
        document.getElementById('json-groups-modal').style.display = 'none';
        if (jsonGroupsHot) {
            jsonGroupsHot.destroy();
            jsonGroupsHot = null;
        }
    }
    
    function saveJsonGroups() {
        if (!jsonGroupsHot || jsonEditingRow === null) return;
        
        const data = jsonGroupsHot.getSourceData();
        const groups = [];
        
        data.forEach(row => {
            if (row.nome && row.nome.trim()) {
                const variantes = row.variantes ? row.variantes.split(',').map(v => v.trim()).filter(v => v) : [];
                groups.push({
                    nome: row.nome.trim(),
                    slug: row.slug ? row.slug.trim() : row.nome.trim().toLowerCase().replace(/\s+/g, '-'),
                    descricao: row.descricao || '',
                    variantes: variantes
                });
            }
        });
        
        // Update the products table
        productsHot.setDataAtRowProp(jsonEditingRow, 'groups_json', groups.length > 0 ? groups : null);
        
        closeJsonGroupsModal();
    }
    
    // =============================================================================
    // CATEGORIES MODAL (JSON-based)
    // =============================================================================
    let categoriesEditingRow = null;
    let allCategories = [];  // Cache for all categories from server
    let selectedCategorySlugs = new Set();  // Currently selected category slugs
    
    async function openCategoriesModal(row) {
        categoriesEditingRow = row;
        const rowData = productsHot.getSourceDataAtRow(row);
        const productId = rowData.id;
        const productName = rowData.name || 'Novo Produto';
        
        document.getElementById('cat-product-name').textContent = productName;
        document.getElementById('category-search').value = '';
        
        // Initialize selected categories from current JSON data
        selectedCategorySlugs = new Set();
        const currentCategories = rowData.categories_json || [];
        currentCategories.forEach(c => {
            if (c.slug) selectedCategorySlugs.add(c.slug);
        });
        
        // Show modal
        document.getElementById('categories-modal').style.display = 'block';
        
        // Load categories from server
        await loadCategoriesForModal();
        
        renderSelectedCategories();
        renderCategoriesList('');
    }
    
    async function loadCategoriesForModal() {
        try {
            const response = await fetch('/catalog/bulk-edit/categories/search/');
            const data = await response.json();
            allCategories = data.categories || [];
        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
            allCategories = [];
        }
    }
    
    function searchCategories(query) {
        renderCategoriesList(query.toLowerCase().trim());
    }
    
    function renderSelectedCategories() {
        const container = document.getElementById('selected-cats-container');
        
        if (selectedCategorySlugs.size === 0) {
            container.innerHTML = '<span style="color: #666; font-style: italic;">Nenhuma categoria selecionada</span>';
            return;
        }
        
        const selectedCats = allCategories.filter(c => selectedCategorySlugs.has(c.slug));
        container.innerHTML = selectedCats.map(cat => `
            <span style="display: inline-flex; align-items: center; background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin: 2px;">
                ${cat.full_path}
                <button onclick="removeCategorySelection('${cat.slug}')" 
                        style="background: none; border: none; color: #666; cursor: pointer; margin-left: 5px; font-size: 14px;">√ó</button>
            </span>
        `).join('');
    }
    
    // Track collapsed categories in modal
    let modalCollapsedCategories = new Set();
    
    function expandAllModalCategories() {
        modalCollapsedCategories.clear();
        renderCategoriesList(document.getElementById('category-search').value.toLowerCase().trim());
    }
    
    function collapseAllModalCategories() {
        // Collapse all categories that have children
        allCategories.forEach(cat => {
            if (cat.has_children) {
                modalCollapsedCategories.add(cat.id);
            }
        });
        renderCategoriesList(document.getElementById('category-search').value.toLowerCase().trim());
    }
    
    function isModalCategoryCollapsed(catId) {
        return modalCollapsedCategories.has(catId);
    }
    
    function isCategoryHiddenByParent(cat) {
        // Check if any ancestor is collapsed
        let parentId = cat.parent_id;
        while (parentId) {
            if (modalCollapsedCategories.has(parentId)) {
                return true;
            }
            const parent = allCategories.find(c => c.id === parentId);
            parentId = parent ? parent.parent_id : null;
        }
        return false;
    }
    
    function toggleModalCategoryCollapse(catId) {
        if (modalCollapsedCategories.has(catId)) {
            modalCollapsedCategories.delete(catId);
        } else {
            modalCollapsedCategories.add(catId);
        }
        renderCategoriesList(document.getElementById('category-search').value.toLowerCase().trim());
    }
    
    function renderCategoriesList(query) {
        const container = document.getElementById('categories-list');
        
        // Filter categories by query (if searching, show all matching regardless of collapse)
        let filtered = allCategories;
        const isSearching = query && query.length > 0;
        
        if (isSearching) {
            filtered = allCategories.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.full_path.toLowerCase().includes(query)
            );
        }
        
        if (filtered.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma categoria encontrada</p>';
            return;
        }
        
        let html = '';
        
        // Render categories (already in hierarchical order from server)
        filtered.forEach(cat => {
            // Skip if hidden by collapsed parent (unless searching)
            if (!isSearching && isCategoryHiddenByParent(cat)) {
                return;
            }
            
            const isSelected = selectedCategorySlugs.has(cat.slug);
            const indent = cat.level * 20;
            const bgColor = isSelected ? '#e3f2fd' : 'transparent';
            const hasChildren = cat.has_children;
            const isCollapsed = modalCollapsedCategories.has(cat.id);
            
            // Toggle icon
            let toggleIcon = '';
            if (hasChildren) {
                const icon = isCollapsed ? '‚ñ∂' : '‚ñº';
                toggleIcon = `<span onclick="event.stopPropagation(); toggleModalCategoryCollapse(${cat.id})" 
                                   style="cursor: pointer; width: 16px; display: inline-block; text-align: center; font-size: 10px; color: #666; margin-right: 4px;">${icon}</span>`;
            } else if (cat.level > 0) {
                toggleIcon = `<span style="width: 16px; display: inline-block; text-align: center; font-size: 10px; color: #999; margin-right: 4px;">‚îî</span>`;
            } else {
                toggleIcon = `<span style="width: 16px; display: inline-block; text-align: center; font-size: 10px; color: #999; margin-right: 4px;">‚Ä¢</span>`;
            }
            
            html += `
                <div style="display: flex; align-items: center; padding: 8px 10px; padding-left: ${indent + 10}px; background: ${bgColor}; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #333;"
                     onclick="toggleCategorySelection('${cat.slug}')">
                    ${toggleIcon}
                    <input type="checkbox" ${isSelected ? 'checked' : ''} 
                           style="width: auto !important; margin: 0 8px 0 0 !important; flex-shrink: 0; padding: 0 !important;"
                           onclick="event.stopPropagation(); toggleCategorySelection('${cat.slug}')">
                    <span style="flex: 1; color: #333;">
                        <strong style="color: #222;">${cat.name}</strong>
                        ${cat.parent_name ? `<span style="color: #666; font-size: 11px; margin-left: 5px;">(${cat.parent_name})</span>` : ''}
                    </span>
                </div>
            `;
        });
        
        container.innerHTML = html || '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma categoria encontrada</p>';
    }
    
    function toggleCategorySelection(slug) {
        if (selectedCategorySlugs.has(slug)) {
            selectedCategorySlugs.delete(slug);
        } else {
            selectedCategorySlugs.add(slug);
        }
        renderSelectedCategories();
        renderCategoriesList(document.getElementById('category-search').value.toLowerCase().trim());
    }
    
    function removeCategorySelection(slug) {
        selectedCategorySlugs.delete(slug);
        renderSelectedCategories();
        renderCategoriesList(document.getElementById('category-search').value.toLowerCase().trim());
    }
    
    function closeCategoriesModal() {
        document.getElementById('categories-modal').style.display = 'none';
        categoriesEditingRow = null;
    }
    
    function saveProductCategories() {
        if (categoriesEditingRow === null) return;
        
        // Build categories JSON from selected slugs
        const categoriesJson = [];
        allCategories.forEach(cat => {
            if (selectedCategorySlugs.has(cat.slug)) {
                categoriesJson.push({
                    nome: cat.name,
                    slug: cat.slug,
                    full_path: cat.full_path,
                    pai: cat.parent_slug || null,
                });
            }
        });
        
        // Update the products table with JSON data
        productsHot.setDataAtRowProp(
            categoriesEditingRow, 
            'categories_json', 
            categoriesJson.length > 0 ? categoriesJson : null
        );
        
        closeCategoriesModal();
        setStatus('products-status', 'Categorias atualizadas. Clique em "Salvar Altera√ß√µes" para persistir.', 'info');
    }
    
    function addProductRow() {
        if (!productsHot) {
            loadProducts();
            return;
        }
        productsHot.alter('insert_row_below', productsHot.countRows());
    }
    
    function saveProducts() {
        if (!productsHot) return;
        
        const allData = productsHot.getSourceData();
        const toCreate = [];
        const toUpdate = [];
        
        allData.forEach((row, index) => {
            if (!row.name) return; // Skip empty rows
            
            if (newProductRows.has(index) || !row.id) {
                toCreate.push({
                    name: row.name,
                    slug: row.slug || '',
                    description: row.description || '',
                    is_active: row.is_active !== false,
                    // Inline variant fields
                    sku: row.sku || '',
                    cost_price: row.cost_price,
                    sell_price: row.sell_price,
                    compare_at_price: row.compare_at_price,
                    stock_quantity: row.stock_quantity || 0,
                    // JSON data - preserve empty arrays [] to signal deletion
                    attributes_json: row.attributes_json !== undefined ? row.attributes_json : null,
                    variants_json: row.variants_json !== undefined ? row.variants_json : null,
                    groups_json: row.groups_json !== undefined ? row.groups_json : null,
                    categories_json: row.categories_json !== undefined ? row.categories_json : null
                });
            } else {
                toUpdate.push({
                    id: row.id,
                    name: row.name,
                    slug: row.slug,
                    description: row.description,
                    is_active: row.is_active,
                    // Inline variant fields
                    has_variants: row.has_variants,
                    variant_id: row.variant_id,
                    sku: row.sku || '',
                    cost_price: row.cost_price,
                    sell_price: row.sell_price,
                    compare_at_price: row.compare_at_price,
                    stock_quantity: row.stock_quantity || 0,
                    // JSON data - preserve empty arrays [] to signal deletion
                    attributes_json: row.attributes_json !== undefined ? row.attributes_json : null,
                    variants_json: row.variants_json !== undefined ? row.variants_json : null,
                    groups_json: row.groups_json !== undefined ? row.groups_json : null,
                    categories_json: row.categories_json !== undefined ? row.categories_json : null
                });
            }
        });
        
        console.log('Saving products - Create:', toCreate);
        console.log('Saving products - Update:', toUpdate);
        
        setStatus('products-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_products_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({create: toCreate, update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            console.log('Save result:', result);
            if (result.status === 'ok') {
                let msg = `‚úì ${result.created} criado(s), ${result.updated} atualizado(s)`;
                let statusType = 'success';
                
                if (result.errors && result.errors.length > 0) {
                    msg += ` (${result.errors.length} erro(s))`;
                    console.error('Save errors:', result.errors);
                }
                
                // Show warnings if any
                if (result.warnings && result.warnings.length > 0) {
                    statusType = 'warning';
                    msg += ` ‚ö†Ô∏è ${result.warnings.length} aviso(s)`;
                    console.warn('Save warnings:', result.warnings);
                    
                    // Show alert with warnings
                    const warningText = result.warnings.join('\n\n');
                    alert('‚ö†Ô∏è AVISOS:\n\n' + warningText);
                }
                
                setStatus('products-status', msg, statusType);
                newProductRows.clear();
                loadProducts(); // Reload to get IDs
            } else {
                setStatus('products-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('products-status', `Erro: ${error}`, 'error');
        });
    }
    
    // =============================================================================
    // VARIANTS TAB
    // =============================================================================
    
    function loadVariants() {
        const productId = document.getElementById('variant-product-select').value;
        if (!productId) {
            setStatus('variants-status', 'Selecione um produto.', 'info');
            return;
        }
        
        currentProductId = productId;
        setStatus('variants-status', 'Carregando variantes...', 'info');
        
        fetch(`{% url "catalog:bulk_variants_data" %}?product_id=${productId}`)
            .then(response => response.json())
            .then(data => {
                initVariantsGrid(data);
                setStatus('variants-status', `${data.data.length} variantes carregadas.`, 'success');
            })
            .catch(error => {
                setStatus('variants-status', `Erro: ${error}`, 'error');
            });
    }
    
    function initVariantsGrid(jsonData) {
        const container = document.getElementById('variants-grid');
        
        if (variantsHot) {
            variantsHot.destroy();
        }
        
        newVariantRows.clear();
        
        // Custom renderer for variant thumbnail - clickable to open image manager
        function variantThumbnailRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            td.innerHTML = '';
            const rowData = instance.getSourceDataAtRow(row);
            
            if (!rowData || !rowData.id) {
                // New row - show upload prompt
                td.innerHTML = '<span style="color:#999;font-size:10px;cursor:pointer;" title="Salve primeiro">üíæ</span>';
                td.style.textAlign = 'center';
                return;
            }
            
            const variantId = rowData.id;
            const imageCount = rowData.image_count || 0;
            
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display:flex;flex-direction:column;align-items:center;cursor:pointer;';
            wrapper.title = `Clique para gerenciar imagens (${imageCount})`;
            wrapper.onclick = () => openImageModal(variantId, rowData.sku);
            
            if (value) {
                const img = document.createElement('img');
                img.src = value;
                img.style.cssText = 'width:36px;height:36px;object-fit:cover;border-radius:3px;';
                wrapper.appendChild(img);
            } else {
                const icon = document.createElement('span');
                icon.innerHTML = 'üì∑';
                icon.style.fontSize = '20px';
                wrapper.appendChild(icon);
            }
            
            // Image count badge
            const badge = document.createElement('span');
            badge.style.cssText = 'font-size:9px;color:#666;margin-top:2px;';
            badge.textContent = `(${imageCount})`;
            wrapper.appendChild(badge);
            
            td.appendChild(wrapper);
            td.style.textAlign = 'center';
        }
        
        // Build columns dynamically based on attributes
        const columns = [
            {data: 'thumbnail_url', renderer: variantThumbnailRenderer, readOnly: true, width: 60, title: 'üì∑'},
            {data: 'id', readOnly: true, width: 50, title: 'ID'},
            {data: 'sku', width: 120, title: 'SKU'},
            {data: 'name', width: 180, title: 'Nome'},
        ];
        
        // Add attribute columns
        if (jsonData.attribute_columns) {
            jsonData.attribute_columns.forEach(attr => {
                columns.push({
                    data: `attr_${attr.slug}`,
                    width: 100,
                    title: attr.name,
                    type: 'dropdown',
                    source: attr.options
                });
            });
        }
        
        columns.push(
            {data: 'cost_price', type: 'numeric', numericFormat: {pattern: '0.00'}, width: 100, title: 'Pre√ßo Custo'},
            {data: 'sell_price', type: 'numeric', numericFormat: {pattern: '0.00'}, width: 100, title: 'Pre√ßo Venda'},
            {data: 'compare_at_price', type: 'numeric', numericFormat: {pattern: '0.00'}, width: 100, title: 'Pre√ßo Comp.'},
            {data: 'stock_quantity', type: 'numeric', width: 80, title: 'Estoque'},
            {data: 'is_active', type: 'checkbox', width: 60, title: 'Ativo'},
        );
        
        variantsHot = new Handsontable(container, {
            data: jsonData.data,
            colHeaders: columns.map(c => c.title),
            columns: columns,
            rowHeaders: true,
            contextMenu: {
                items: {
                    'row_above': {name: 'Inserir linha acima'},
                    'row_below': {name: 'Inserir linha abaixo'},
                    'duplicate_row': {
                        name: 'Duplicar linha',
                        callback: function(key, selection) {
                            duplicateRow(this, selection[0].start.row);
                        }
                    },
                    'remove_row': {name: 'Remover linha'},
                    'separator': Handsontable.plugins.ContextMenu.SEPARATOR,
                    'copy': {name: 'Copiar'},
                    'cut': {name: 'Recortar'},
                    'separator2': Handsontable.plugins.ContextMenu.SEPARATOR,
                    'undo': {name: 'Desfazer'},
                    'redo': {name: 'Refazer'},
                }
            },
            manualColumnResize: true,
            filters: true,
            dropdownMenu: true,
            multiColumnSorting: true,
            stretchH: 'all',
            height: '100%',
            copyPaste: true,
            fillHandle: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            afterCreateRow: function(index, amount) {
                for (let i = 0; i < amount; i++) {
                    newVariantRows.add(index + i);
                    this.setDataAtRowProp(index + i, 'is_active', true);
                    this.setDataAtRowProp(index + i, 'stock_quantity', 0);
                }
                this.render();
            },
            
            afterRemoveRow: function(index, amount) {
                const updated = new Set();
                newVariantRows.forEach(row => {
                    if (row >= index + amount) {
                        updated.add(row - amount);
                    } else if (row < index) {
                        updated.add(row);
                    }
                });
                newVariantRows = updated;
            },
            
            cells: function(row, col) {
                const cellProperties = {};
                if (newVariantRows.has(row)) {
                    cellProperties.className = 'new-row';
                }
                return cellProperties;
            }
        });
        
        // Store attribute info for saving
        variantsHot.attributeColumns = jsonData.attribute_columns || [];
    }
    
    function duplicateRow(hot, rowIndex) {
        const rowData = hot.getSourceDataAtRow(rowIndex);
        const newRow = {...rowData, id: null, sku: rowData.sku + '_copy'};
        
        hot.alter('insert_row_below', rowIndex);
        const newRowIndex = rowIndex + 1;
        
        Object.keys(newRow).forEach(key => {
            hot.setDataAtRowProp(newRowIndex, key, newRow[key]);
        });
        
        newVariantRows.add(newRowIndex);
        hot.render();
    }
    
    function duplicateVariantRows() {
        if (!variantsHot) return;
        
        const selected = variantsHot.getSelected();
        if (!selected || selected.length === 0) {
            setStatus('variants-status', 'Selecione pelo menos uma linha para duplicar.', 'warning');
            return;
        }
        
        // Get unique rows
        const rows = new Set();
        selected.forEach(([row1, col1, row2, col2]) => {
            for (let r = Math.min(row1, row2); r <= Math.max(row1, row2); r++) {
                rows.add(r);
            }
        });
        
        // Duplicate each row (in reverse to maintain indices)
        const sortedRows = Array.from(rows).sort((a, b) => b - a);
        sortedRows.forEach(row => {
            duplicateRow(variantsHot, row);
        });
        
        setStatus('variants-status', `${rows.size} linha(s) duplicada(s).`, 'success');
    }
    
    function addVariantRow() {
        if (!variantsHot) {
            setStatus('variants-status', 'Carregue as variantes de um produto primeiro.', 'warning');
            return;
        }
        variantsHot.alter('insert_row_below', variantsHot.countRows());
    }
    
    function saveVariants() {
        if (!variantsHot || !currentProductId) return;
        
        const allData = variantsHot.getSourceData();
        const attrColumns = variantsHot.attributeColumns || [];
        const toCreate = [];
        const toUpdate = [];
        
        allData.forEach((row, index) => {
            if (!row.sku) return; // Skip empty rows
            
            // Extract attributes
            const attributes = {};
            attrColumns.forEach(attr => {
                const val = row[`attr_${attr.slug}`];
                if (val) {
                    attributes[attr.slug] = val;
                }
            });
            
            const variantData = {
                sku: row.sku,
                name: row.name || '',
                cost_price: row.cost_price,
                sell_price: row.sell_price,
                compare_at_price: row.compare_at_price,
                stock_quantity: row.stock_quantity || 0,
                is_active: row.is_active !== false,
                attributes: attributes
            };
            
            if (newVariantRows.has(index) || !row.id) {
                variantData.product_id = currentProductId;
                toCreate.push(variantData);
            } else {
                variantData.id = row.id;
                toUpdate.push(variantData);
            }
        });
        
        setStatus('variants-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_variants_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({create: toCreate, update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                setStatus('variants-status', 
                    `‚úì ${result.created} criada(s), ${result.updated} atualizada(s)`, 'success');
                newVariantRows.clear();
                loadVariants(); // Reload
            } else {
                setStatus('variants-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('variants-status', `Erro: ${error}`, 'error');
        });
    }
    
    // =============================================================================
    // ATTRIBUTES TAB - Manage Attribute Types
    // =============================================================================
    
    let attrTypesData = [];
    let attrProductsHot = null;  // Grid for products modal
    let attrOptionsHot = null;   // Grid for options modal

    function loadAttributeTypes() {
        setStatus('attributes-status', 'Carregando tipos de atributos...', 'info');
        
        fetch('{% url "catalog:bulk_attr_types_data" %}')
            .then(response => response.json())
            .then(data => {
                attrTypesData = data.data;
                initAttributeTypesGrid(data);
                setStatus('attributes-status', `${data.data.length} tipos de atributos.`, 'success');
            })
            .catch(error => {
                setStatus('attributes-status', `Erro: ${error}`, 'error');
            });
    }
    
    function initAttributeTypesGrid(jsonData) {
        const container = document.getElementById('attributes-grid');
        
        if (attributesHot) {
            attributesHot.destroy();
        }
        
        newAttrOptionRows.clear();
        
        // Renderer for clickable product count
        function productCountRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.id) {
                const count = value || 0;
                if (count > 0) {
                    td.innerHTML = `<a href="#" onclick="showAttrTypeProducts(${rowData.id}, '${rowData.name}'); return false;" style="color:#0066cc; text-decoration:underline;">${count} produtos</a>`;
                } else {
                    td.innerHTML = '<span style="color:#999;">0 produtos</span>';
                }
            } else {
                td.textContent = '';
            }
        }
        
        // Renderer for clickable options count
        function optionsCountRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.id) {
                const count = rowData.options ? rowData.options.length : 0;
                if (count > 0) {
                    td.innerHTML = `<a href="#" onclick="showAttrTypeOptions(${rowData.id}, '${rowData.name}'); return false;" style="color:#0066cc; text-decoration:underline;">${count} op√ß√µes</a>`;
                } else {
                    td.innerHTML = '<span style="color:#999;">0 op√ß√µes</span>';
                }
            } else {
                td.textContent = '';
            }
        }
        
        attributesHot = new Handsontable(container, {
            data: jsonData.data,
            colHeaders: ['ID', 'Nome', 'Slug', 'Tipo de Dado', 'Ordem', 'Produtos', 'Op√ß√µes'],
            columns: [
                {data: 'id', readOnly: true, width: 50},
                {data: 'name', width: 150},
                {data: 'slug', width: 120},
                {data: 'datatype', type: 'dropdown', source: ['text', 'number', 'decimal', 'color'], width: 100},
                {data: 'display_order', type: 'numeric', width: 80},
                {data: 'product_count', renderer: productCountRenderer, readOnly: true, width: 100},
                {data: 'options_count', renderer: optionsCountRenderer, readOnly: true, width: 100},
            ],
            rowHeaders: true,
            contextMenu: true,
            manualColumnResize: true,
            stretchH: 'all',
            height: '100%',
            copyPaste: true,
            fillHandle: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            afterCreateRow: function(index, amount) {
                for (let i = 0; i < amount; i++) {
                    newAttrOptionRows.add(index + i);
                    this.setDataAtRowProp(index + i, 'display_order', 0);
                    this.setDataAtRowProp(index + i, 'datatype', 'text');
                }
                this.render();
            },
            
            cells: function(row, col) {
                const cellProperties = {};
                if (newAttrOptionRows.has(row)) {
                    cellProperties.className = 'new-row';
                }
                return cellProperties;
            }
        });
    }
    
    // --- Products Modal (Handsontable grid) ---
    
    function showAttrTypeProducts(attrTypeId, attrTypeName) {
        currentAttrTypeId = attrTypeId;
        document.getElementById('attr-type-products-name').textContent = attrTypeName;
        document.getElementById('attr-type-products-modal').style.display = 'block';
        setStatus('attr-type-products-status', 'Carregando produtos...', 'info');
        
        fetch(`{% url "catalog:bulk_attr_type_products" %}?attribute_type_id=${attrTypeId}`)
            .then(response => response.json())
            .then(data => {
                initAttrProductsGrid(data.products);
                setStatus('attr-type-products-status', `${data.products.length} produtos encontrados.`, 'success');
            })
            .catch(error => {
                setStatus('attr-type-products-status', `Erro: ${error}`, 'error');
            });
    }
    
    function initAttrProductsGrid(products) {
        const container = document.getElementById('attr-type-products-grid');
        
        if (attrProductsHot) {
            attrProductsHot.destroy();
        }
        
        // Renderer for options badges
        function optionsBadgesRenderer(instance, td, row, col, prop, value, cellProperties) {
            if (value && Array.isArray(value)) {
                td.innerHTML = value.map(o => 
                    `<span style="background:#e3f2fd; padding:2px 8px; border-radius:10px; margin:2px; display:inline-block; font-size:12px;">${o}</span>`
                ).join('');
            } else {
                td.textContent = '';
            }
        }
        
        attrProductsHot = new Handsontable(container, {
            data: products,
            colHeaders: ['ID', 'Produto', 'Op√ß√µes deste Atributo', 'Variantes'],
            columns: [
                {data: 'id', readOnly: true, width: 50},
                {data: 'name', readOnly: true, width: 200},
                {data: 'options', renderer: optionsBadgesRenderer, readOnly: true, width: 300},
                {data: 'variant_count', readOnly: true, width: 80},
            ],
            rowHeaders: true,
            readOnly: true,
            manualColumnResize: true,
            stretchH: 'all',
            height: 350,
            licenseKey: 'non-commercial-and-evaluation',
        });
    }
    
    function closeAttrTypeProductsModal() {
        document.getElementById('attr-type-products-modal').style.display = 'none';
        if (attrProductsHot) {
            attrProductsHot.destroy();
            attrProductsHot = null;
        }
    }
    
    function goToProductsTab() {
        // Close modal and switch to products tab
        closeAttrTypeProductsModal();
        // TODO: Could add filtering by attribute type in products tab
        document.querySelector('.tab[onclick*="products"]').click();
    }
    
    // --- Options Modal (Handsontable grid, editable) ---
    
    function showAttrTypeOptions(attrTypeId, attrTypeName) {
        currentAttrTypeId = attrTypeId;
        document.getElementById('attr-options-type-name').textContent = attrTypeName;
        document.getElementById('attr-options-modal').style.display = 'block';
        setStatus('attr-options-status', 'Carregando op√ß√µes...', 'info');
        
        // Find options from already loaded data
        const attrType = attrTypesData.find(at => at.id === attrTypeId);
        if (attrType && attrType.options) {
            initAttrOptionsGrid(attrType.options);
            setStatus('attr-options-status', `${attrType.options.length} op√ß√µes.`, 'success');
        } else {
            setStatus('attr-options-status', 'Nenhuma op√ß√£o encontrada.', 'info');
            initAttrOptionsGrid([]);
        }
    }
    
    function initAttrOptionsGrid(options) {
        const container = document.getElementById('attr-options-grid');
        
        if (attrOptionsHot) {
            attrOptionsHot.destroy();
        }
        
        // Color preview renderer
        function colorRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            if (value && value.match(/^#[0-9A-Fa-f]{6}$/)) {
                td.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:18px;height:18px;background:${value};border:1px solid #ccc;border-radius:3px;"></span>
                        <span>${value}</span>
                    </div>
                `;
            }
        }
        
        attrOptionsHot = new Handsontable(container, {
            data: options,
            colHeaders: ['ID', 'Valor', 'Valor de Exibi√ß√£o', 'Grupo de Filtro', 'Cor Hex', 'Produto'],
            columns: [
                {data: 'id', readOnly: true, width: 50},
                {data: 'value', readOnly: true, width: 120},
                {data: 'display_value', width: 120},
                {data: 'filter_group', width: 120},
                {data: 'color_hex', renderer: colorRenderer, width: 100},
                {data: 'product_name', readOnly: true, width: 150},
            ],
            rowHeaders: true,
            contextMenu: true,
            manualColumnResize: true,
            stretchH: 'all',
            height: 300,
            copyPaste: true,
            licenseKey: 'non-commercial-and-evaluation',
        });
    }
    
    function closeAttrOptionsModal() {
        document.getElementById('attr-options-modal').style.display = 'none';
        if (attrOptionsHot) {
            attrOptionsHot.destroy();
            attrOptionsHot = null;
        }
    }
    
    function saveAttrOptions() {
        if (!attrOptionsHot) return;
        
        const allData = attrOptionsHot.getSourceData();
        const toUpdate = [];
        
        allData.forEach(row => {
            if (!row.id) return;
            toUpdate.push({
                id: row.id,
                display_value: row.display_value || '',
                filter_group: row.filter_group || '',
                color_hex: row.color_hex || '',
            });
        });
        
        setStatus('attr-options-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_attr_options_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                setStatus('attr-options-status', `‚úì ${result.updated} op√ß√£o(√µes) atualizada(s).`, 'success');
                // Reload main grid to refresh options count
                loadAttributeTypes();
            } else {
                setStatus('attr-options-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('attr-options-status', `Erro: ${error}`, 'error');
        });
    }
    
    // --- Save Attribute Types ---
    
    function saveAttributeTypes() {
        if (!attributesHot) return;
        
        const allData = attributesHot.getSourceData();
        const toCreate = [];
        const toUpdate = [];
        
        allData.forEach((row, index) => {
            if (!row.name) return;
            
            const typeData = {
                name: row.name,
                slug: row.slug || '',
                datatype: row.datatype || 'text',
                display_order: row.display_order || 0
            };
            
            if (newAttrOptionRows.has(index) || !row.id) {
                toCreate.push(typeData);
            } else {
                typeData.id = row.id;
                toUpdate.push(typeData);
            }
        });
        
        setStatus('attributes-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_attr_types_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({create: toCreate, update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                setStatus('attributes-status', 
                    `‚úì ${result.created || 0} criado(s), ${result.updated || 0} atualizado(s)`, 'success');
                newAttrOptionRows.clear();
                loadAttributeTypes();
            } else {
                setStatus('attributes-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('attributes-status', `Erro: ${error}`, 'error');
        });
    }
    
    // =============================================================================
    // GROUPS TAB
    // =============================================================================
    
    let groupsHot = null;
    let currentGroupProductId = null;
    let newGroupRows = new Set();
    
    function loadGroups() {
        const productId = document.getElementById('group-product-select').value;
        if (!productId) {
            setStatus('groups-status', 'Selecione um produto.', 'info');
            return;
        }
        
        currentGroupProductId = productId;
        setStatus('groups-status', 'Carregando grupos...', 'info');
        
        fetch(`{% url "catalog:bulk_groups_data" %}?product_id=${productId}`)
            .then(response => response.json())
            .then(data => {
                initGroupsGrid(data);
                setStatus('groups-status', `${data.data.length} grupo(s) carregado(s).`, 'success');
            })
            .catch(error => {
                setStatus('groups-status', `Erro: ${error}`, 'error');
            });
    }
    
    function initGroupsGrid(jsonData) {
        const container = document.getElementById('groups-grid');
        
        if (groupsHot) {
            groupsHot.destroy();
        }
        
        newGroupRows.clear();
        
        // Renderer for variant count with link
        function variantCountRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const rowData = instance.getSourceDataAtRow(row);
            if (rowData && rowData.id) {
                td.innerHTML = `<a href="#" onclick="openGroupVariantsModal(${rowData.id}, '${rowData.name}'); return false;" 
                    style="color:#417690;">${value || 0} variantes</a>`;
            } else {
                td.textContent = value || 0;
            }
            td.style.textAlign = 'center';
        }
        
        groupsHot = new Handsontable(container, {
            data: jsonData.data,
            colHeaders: ['ID', 'Nome', 'Slug', 'Descri√ß√£o', 'Ativo', 'Variantes'],
            columns: [
                {data: 'id', readOnly: true, width: 50},
                {data: 'name', width: 200},
                {data: 'slug', width: 150},
                {data: 'description', width: 300},
                {data: 'is_active', type: 'checkbox', width: 60},
                {data: 'variant_count', renderer: variantCountRenderer, readOnly: true, width: 100},
            ],
            rowHeaders: true,
            contextMenu: {
                items: {
                    'row_above': {name: 'Inserir linha acima'},
                    'row_below': {name: 'Inserir linha abaixo'},
                    'remove_row': {name: 'Remover linha'},
                    'separator': Handsontable.plugins.ContextMenu.SEPARATOR,
                    'copy': {name: 'Copiar'},
                    'cut': {name: 'Recortar'},
                }
            },
            manualColumnResize: true,
            stretchH: 'all',
            height: '100%',
            copyPaste: true,
            fillHandle: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            afterCreateRow: function(index, amount) {
                for (let i = 0; i < amount; i++) {
                    newGroupRows.add(index + i);
                    this.setDataAtRowProp(index + i, 'is_active', true);
                }
                this.render();
            },
            
            cells: function(row, col) {
                const cellProperties = {};
                if (newGroupRows.has(row)) {
                    cellProperties.className = 'new-row';
                }
                return cellProperties;
            }
        });
    }
    
    function addGroupRow() {
        if (!groupsHot) {
            setStatus('groups-status', 'Selecione um produto primeiro.', 'warning');
            return;
        }
        groupsHot.alter('insert_row_below', groupsHot.countRows());
    }
    
    function saveGroups() {
        if (!groupsHot || !currentGroupProductId) return;
        
        const allData = groupsHot.getSourceData();
        const toCreate = [];
        const toUpdate = [];
        
        allData.forEach((row, index) => {
            if (!row.name) return;
            
            if (newGroupRows.has(index) || !row.id) {
                toCreate.push({
                    product_id: currentGroupProductId,
                    name: row.name,
                    slug: row.slug || '',
                    description: row.description || '',
                    is_active: row.is_active !== false
                });
            } else {
                toUpdate.push({
                    id: row.id,
                    name: row.name,
                    slug: row.slug,
                    description: row.description,
                    is_active: row.is_active
                });
            }
        });
        
        setStatus('groups-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_groups_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({create: toCreate, update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                setStatus('groups-status', 
                    `‚úì ${result.created} criado(s), ${result.updated} atualizado(s)`, 'success');
                newGroupRows.clear();
                loadGroups();
            } else {
                setStatus('groups-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('groups-status', `Erro: ${error}`, 'error');
        });
    }
    
    function openGroupVariantsModal(groupId, groupName) {
        // For now, open admin page - could be enhanced with a modal
        window.open(`/admin/catalog/variantgroupmembership/?variant_group__id__exact=${groupId}`, '_blank');
    }
    
    // =============================================================================
    // MODALS
    // =============================================================================
    
    function getSelectedVariantIds() {
        if (!variantsHot) return [];
        
        const selected = variantsHot.getSelected();
        console.log('Selected ranges:', selected);
        
        if (!selected || selected.length === 0) return [];
        
        const variantIds = [];
        for (const selection of selected) {
            const [row1, col1, row2, col2] = selection;
            const startRow = Math.min(row1, row2);
            const endRow = Math.max(row1, row2);
            
            for (let row = startRow; row <= endRow; row++) {
                const rowData = variantsHot.getSourceDataAtRow(row);
                console.log('Row', row, 'data:', rowData);
                if (rowData && rowData.id && !variantIds.includes(rowData.id)) {
                    variantIds.push(rowData.id);
                }
            }
        }
        console.log('Selected variant IDs:', variantIds);
        return variantIds;
    }
    
    let pendingVariantIds = [];
    
    function openGroupModal() {
        if (!variantsHot) {
            setStatus('variants-status', 'Carregue as variantes primeiro.', 'error');
            return;
        }
        
        pendingVariantIds = getSelectedVariantIds();
        console.log('Pending variant IDs:', pendingVariantIds);
        
        if (pendingVariantIds.length === 0) {
            setStatus('variants-status', 'Selecione pelo menos uma variante salva. Dica: Clique no n√∫mero da linha √† esquerda para selecionar a linha inteira.', 'warning');
            return;
        }
        
        // Show how many variants are selected
        document.getElementById('selected-variants-info').textContent = 
            `${pendingVariantIds.length} variante(s) selecionada(s)`;
        
        // Filter groups dropdown to show only groups from current product
        const select = document.getElementById('modal-group-select');
        const currentProdId = currentProductId;
        
        Array.from(select.options).forEach(option => {
            if (option.value === '') return;
            const prodId = option.dataset.product;
            option.style.display = (prodId == currentProdId) ? '' : 'none';
        });
        
        // Reset form
        document.querySelector('input[name="group-action"][value="existing"]').checked = true;
        toggleGroupForm();
        document.getElementById('new-group-name').value = '';
        document.getElementById('new-group-slug').value = '';
        document.getElementById('new-group-description').value = '';
        
        document.getElementById('group-modal').style.display = 'block';
    }
    
    function closeGroupModal() {
        document.getElementById('group-modal').style.display = 'none';
        pendingVariantIds = [];
    }
    
    function toggleGroupForm() {
        const action = document.querySelector('input[name="group-action"]:checked').value;
        document.getElementById('existing-group-form').style.display = (action === 'existing') ? 'block' : 'none';
        document.getElementById('new-group-form').style.display = (action === 'new') ? 'block' : 'none';
    }
    
    function submitGroupAction() {
        const action = document.querySelector('input[name="group-action"]:checked').value;
        
        if (action === 'existing') {
            addToExistingGroup();
        } else {
            createNewGroupWithVariants();
        }
    }
    
    function addToExistingGroup() {
        const groupId = document.getElementById('modal-group-select').value;
        if (!groupId) {
            alert('Selecione um grupo.');
            return;
        }
        
        if (pendingVariantIds.length === 0) {
            alert('Nenhuma variante selecionada.');
            return;
        }
        
        fetch('{% url "catalog:bulk_add_to_group" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                group_id: groupId,
                variant_ids: pendingVariantIds
            })
        })
        .then(response => response.json())
        .then(result => {
            closeGroupModal();
            if (result.status === 'ok') {
                setStatus('variants-status', `‚úì ${result.added} variante(s) adicionada(s) ao grupo!`, 'success');
            } else {
                setStatus('variants-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            closeGroupModal();
            setStatus('variants-status', `Erro: ${error}`, 'error');
        });
    }
    
    function createNewGroupWithVariants() {
        const name = document.getElementById('new-group-name').value.trim();
        if (!name) {
            alert('O nome do grupo √© obrigat√≥rio.');
            return;
        }
        
        if (pendingVariantIds.length === 0) {
            alert('Nenhuma variante selecionada.');
            return;
        }
        
        const slug = document.getElementById('new-group-slug').value.trim();
        const description = document.getElementById('new-group-description').value.trim();
        
        fetch('{% url "catalog:bulk_create_group_with_variants" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: currentProductId,
                name: name,
                slug: slug,
                description: description,
                variant_ids: pendingVariantIds
            })
        })
        .then(response => response.json())
        .then(result => {
            closeGroupModal();
            if (result.status === 'ok') {
                setStatus('variants-status', 
                    `‚úì Grupo "${result.group_name}" criado com ${result.variants_added} variante(s)!`, 'success');
                // Add new group to dropdown
                const select = document.getElementById('modal-group-select');
                const option = document.createElement('option');
                option.value = result.group_id;
                option.dataset.product = currentProductId;
                option.textContent = result.group_name;
                select.appendChild(option);
            } else {
                setStatus('variants-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            closeGroupModal();
            setStatus('variants-status', `Erro: ${error}`, 'error');
        });
    }
    
    // Auto-generate slug for new group
    document.getElementById('new-group-name').addEventListener('input', function() {
        const slug = this.value.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        document.getElementById('new-group-slug').value = slug;
    });
    
    function openNewAttrTypeModal() {
        document.getElementById('attr-type-modal').style.display = 'block';
    }
    
    function closeAttrTypeModal() {
        document.getElementById('attr-type-modal').style.display = 'none';
    }
    
    function createAttributeType() {
        const name = document.getElementById('new-attr-type-name').value;
        const slug = document.getElementById('new-attr-type-slug').value;
        const datatype = document.getElementById('new-attr-type-datatype').value;
        
        if (!name || !slug) {
            alert('Nome e slug s√£o obrigat√≥rios.');
            return;
        }
        
        fetch('{% url "catalog:bulk_create_attr_type" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({name, slug, datatype})
        })
        .then(response => response.json())
        .then(result => {
            closeAttrTypeModal();
            if (result.status === 'ok') {
                setStatus('attributes-status', `Tipo "${name}" criado com sucesso!`, 'success');
                // Clear form and reload grid
                document.getElementById('new-attr-type-name').value = '';
                document.getElementById('new-attr-type-slug').value = '';
                loadAttributeTypes();
            } else {
                setStatus('attributes-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            closeAttrTypeModal();
            setStatus('attributes-status', `Erro: ${error}`, 'error');
        });
    }
    
    // =============================================================================
    // CATEGORIES TAB
    // =============================================================================
    
    let allCategoriesData = [];
    let allProductsForCategories = [];
    let currentCategoryId = null;
    let initialProductIds = [];
    let collapsedCategories = new Set();  // IDs of collapsed parent categories
    
    function loadCategoriesGrid() {
        setStatus('categories-status', 'Carregando categorias...', 'info');
        
        fetch('{% url "catalog:bulk_categories_data" %}')
            .then(response => response.json())
            .then(data => {
                allCategoriesData = data.data || [];
                allProductsForCategories = data.products || [];
                initCategoriesGrid(data);
                setStatus('categories-status', `${allCategoriesData.length} categoria(s) carregada(s).`, 'success');
            })
            .catch(error => {
                setStatus('categories-status', `Erro: ${error}`, 'error');
            });
    }
    
    // Check if a row should be hidden based on collapsed parents
    function isRowCollapsed(rowData) {
        if (!rowData || !rowData.parent_id) return false;
        
        // Check if any ancestor is collapsed
        let parentId = rowData.parent_id;
        while (parentId) {
            if (collapsedCategories.has(parentId)) {
                return true;
            }
            // Find parent's parent
            const parent = allCategoriesData.find(c => c.id === parentId);
            parentId = parent ? parent.parent_id : null;
        }
        return false;
    }
    
    // Toggle collapse state for a category
    function toggleCategoryCollapse(categoryId) {
        if (collapsedCategories.has(categoryId)) {
            collapsedCategories.delete(categoryId);
        } else {
            collapsedCategories.add(categoryId);
        }
        categoriesHot.render();
    }
    
    function expandAllCategories() {
        collapsedCategories.clear();
        if (categoriesHot) categoriesHot.render();
    }
    
    function collapseAllCategories() {
        // Collapse all categories that have children
        allCategoriesData.forEach(cat => {
            if (cat.has_children) {
                collapsedCategories.add(cat.id);
            }
        });
        if (categoriesHot) categoriesHot.render();
    }
    
    function initCategoriesGrid(jsonData) {
        const container = document.getElementById('categories-grid');
        
        if (categoriesHot) {
            categoriesHot.destroy();
        }
        
        newCategoryRows.clear();
        
        // Custom renderer for category name with indentation and toggle
        function categoryNameRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            const level = rowData ? (rowData.level || 0) : 0;
            const hasChildren = rowData ? rowData.has_children : false;
            const catId = rowData ? rowData.id : null;
            const isCollapsed = catId && collapsedCategories.has(catId);
            
            // Build indentation
            let indent = '';
            for (let i = 0; i < level; i++) {
                indent += '<span class="category-indent"></span>';
            }
            
            // Toggle button
            let toggle = '';
            if (hasChildren && catId) {
                const icon = isCollapsed ? '‚ñ∂' : '‚ñº';
                toggle = `<span class="category-toggle" onclick="event.stopPropagation(); toggleCategoryCollapse(${catId})">${icon}</span>`;
            } else if (level > 0) {
                toggle = '<span class="category-toggle">‚îî</span>';
            } else {
                toggle = '<span class="category-toggle">‚Ä¢</span>';
            }
            
            td.innerHTML = `<div class="category-name-cell">${indent}${toggle}<span>${value || ''}</span></div>`;
            td.className = `category-level-${Math.min(level, 3)}`;
            
            if (newCategoryRows.has(row)) {
                td.classList.add('new-row');
            }
        }
        
        // Custom renderer for product count with clickable link
        function productCountRenderer(instance, td, row, col, prop, value, cellProperties) {
            const rowData = instance.getSourceDataAtRow(row);
            const catId = rowData ? rowData.id : null;
            const count = value || 0;
            
            if (catId) {
                td.innerHTML = `<a href="javascript:void(0)" onclick="openCategoryProductsModal(${catId}, '${(rowData.name || '').replace(/'/g, "\\'")}', ${count})" style="color:#417690; text-decoration:underline;">(${count} produtos)</a>`;
            } else {
                td.textContent = `(${count} produtos)`;
            }
        }
        
        // Custom renderer for parent category
        function parentRenderer(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            if (value) {
                const parent = allCategoriesData.find(c => c.id == value);
                td.textContent = parent ? parent.full_path : `ID: ${value}`;
            } else {
                td.textContent = '(Raiz)';
            }
        }
        
        // Dropdown source for parent categories
        const parentOptions = [{value: '', label: '(Raiz)'}];
        allCategoriesData.forEach(cat => {
            parentOptions.push({value: cat.id, label: cat.full_path});
        });
        
        categoriesHot = new Handsontable(container, {
            data: jsonData.data,
            colHeaders: ['ID', 'Nome', 'Slug', 'Descri√ß√£o', 'Categoria Pai', 'Caminho', 'Produtos', 'Ativa'],
            columns: [
                {data: 'id', readOnly: true, width: 50},
                {data: 'name', width: 250, renderer: categoryNameRenderer},
                {data: 'slug', width: 150},
                {data: 'description', width: 200},
                {data: 'parent_id', width: 180, renderer: parentRenderer, type: 'dropdown', source: parentOptions.map(o => o.label), strict: false},
                {data: 'full_path', readOnly: true, width: 250},
                {data: 'product_count', readOnly: true, width: 110, renderer: productCountRenderer},
                {data: 'is_active', type: 'checkbox', width: 60}
            ],
            rowHeaders: true,
            contextMenu: true,
            manualColumnResize: true,
            stretchH: 'all',
            height: '100%',
            copyPaste: true,
            fillHandle: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            // Hide rows that are collapsed
            beforeRenderer: function(TD, row, col, prop, value, cellProperties) {
                const rowData = this.getSourceDataAtRow(row);
                if (isRowCollapsed(rowData)) {
                    TD.parentElement && (TD.parentElement.style.display = 'none');
                }
            },
            
            afterRenderer: function(TD, row, col, prop, value, cellProperties) {
                const rowData = this.getSourceDataAtRow(row);
                if (isRowCollapsed(rowData)) {
                    if (TD.parentElement) {
                        TD.parentElement.style.display = 'none';
                    }
                } else {
                    if (TD.parentElement) {
                        TD.parentElement.style.display = '';
                    }
                }
            },
            
            afterCreateRow: function(index, amount) {
                for (let i = 0; i < amount; i++) {
                    newCategoryRows.add(index + i);
                    this.setDataAtRowProp(index + i, 'is_active', true);
                    this.setDataAtRowProp(index + i, 'product_count', 0);
                    this.setDataAtRowProp(index + i, 'level', 0);
                    this.setDataAtRowProp(index + i, 'has_children', false);
                }
                this.render();
            },
            
            beforeChange: function(changes, source) {
                // Convert parent label back to ID
                if (!changes) return;
                changes.forEach(change => {
                    const [row, prop, oldVal, newVal] = change;
                    if (prop === 'parent_id' && typeof newVal === 'string') {
                        if (newVal === '(Raiz)' || newVal === '') {
                            change[3] = null;
                        } else {
                            const parent = allCategoriesData.find(c => c.full_path === newVal);
                            change[3] = parent ? parent.id : null;
                        }
                    }
                });
            },
            
            cells: function(row, col) {
                const cellProperties = {};
                if (newCategoryRows.has(row)) {
                    cellProperties.className = 'new-row';
                }
                return cellProperties;
            }
        });
    }
    
    function addCategoryRow() {
        if (!categoriesHot) {
            loadCategoriesGrid();
            return;
        }
        categoriesHot.alter('insert_row_below', categoriesHot.countRows());
    }
    
    function saveCategories() {
        if (!categoriesHot) return;
        
        const allData = categoriesHot.getSourceData();
        const toCreate = [];
        const toUpdate = [];
        
        allData.forEach((row, index) => {
            if (!row.name) return;
            
            const catData = {
                name: row.name,
                slug: row.slug || '',
                description: row.description || '',
                parent_id: row.parent_id || null,
                is_active: row.is_active !== false
            };
            
            if (newCategoryRows.has(index) || !row.id) {
                toCreate.push(catData);
            } else {
                catData.id = row.id;
                toUpdate.push(catData);
            }
        });
        
        setStatus('categories-status', 'Salvando...', 'info');
        
        fetch('{% url "catalog:bulk_categories_save" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({create: toCreate, update: toUpdate})
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                setStatus('categories-status', 
                    `‚úì ${result.created} criada(s), ${result.updated} atualizada(s)`, 'success');
                newCategoryRows.clear();
                loadCategoriesGrid();
            } else {
                setStatus('categories-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('categories-status', `Erro: ${error}`, 'error');
        });
    }
    
    // --- Category Products Modal ---
    
    function openCategoryProductsModal(categoryId, categoryName, productCount) {
        currentCategoryId = categoryId;
        document.getElementById('cat-products-category-name').textContent = categoryName;
        document.getElementById('cat-products-search').value = '';
        
        // Fetch products with their category membership
        fetch(`/catalog/bulk-edit/categories/${categoryId}/products/`)
            .then(response => response.json())
            .then(data => {
                allProductsForCategories = data.all_products || [];
                initialProductIds = data.category_product_ids || [];
                renderCategoryProductsList(allProductsForCategories, initialProductIds);
                document.getElementById('category-products-modal').style.display = 'block';
            })
            .catch(error => {
                setStatus('categories-status', `Erro ao carregar produtos: ${error}`, 'error');
            });
    }
    
    function renderCategoryProductsList(products, selectedIds) {
        const container = document.getElementById('cat-products-list');
        const selectedCount = selectedIds.length;
        
        let html = '';
        products.forEach(p => {
            const isChecked = selectedIds.includes(p.id);
            html += `
                <label class="category-item" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" value="${p.id}" ${isChecked ? 'checked' : ''} onchange="updateCatProductStats()">
                    <span style="flex:1;">${p.name}</span>
                    <span style="color:#888; font-size:12px;">${p.sku || ''}</span>
                </label>
            `;
        });
        
        container.innerHTML = html || '<p style="padding:20px; color:#888;">Nenhum produto encontrado.</p>';
        updateCatProductStats();
    }
    
    function updateCatProductStats() {
        const checkboxes = document.querySelectorAll('#cat-products-list input[type="checkbox"]');
        const total = checkboxes.length;
        const selected = Array.from(checkboxes).filter(cb => cb.checked).length;
        document.getElementById('cat-products-stats').textContent = `${selected} de ${total} produtos selecionados`;
    }
    
    function filterCategoryProducts(searchTerm) {
        const items = document.querySelectorAll('#cat-products-list .category-item');
        const term = searchTerm.toLowerCase();
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(term) ? 'flex' : 'none';
        });
    }
    
    function closeCategoryProductsModal() {
        document.getElementById('category-products-modal').style.display = 'none';
        currentCategoryId = null;
        initialProductIds = [];
    }
    
    function saveCategoryProducts() {
        if (!currentCategoryId) return;
        
        const checkboxes = document.querySelectorAll('#cat-products-list input[type="checkbox"]');
        const currentProductIds = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                currentProductIds.push(parseInt(cb.value));
            }
        });
        
        // Calculate additions and removals
        const addProductIds = currentProductIds.filter(id => !initialProductIds.includes(id));
        const removeProductIds = initialProductIds.filter(id => !currentProductIds.includes(id));
        
        if (addProductIds.length === 0 && removeProductIds.length === 0) {
            closeCategoryProductsModal();
            return;
        }
        
        fetch(`/catalog/bulk-edit/categories/${currentCategoryId}/products/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                add_product_ids: addProductIds,
                remove_product_ids: removeProductIds
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                closeCategoryProductsModal();
                setStatus('categories-status', 
                    `‚úì ${result.added} produto(s) adicionado(s), ${result.removed} removido(s)`, 'success');
                loadCategoriesGrid();
            } else {
                setStatus('categories-status', `Erro: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            setStatus('categories-status', `Erro: ${error}`, 'error');
        });
    }
    
    // =============================================================================
    // IMAGE MANAGEMENT
    // =============================================================================
    
    function openImageModal(variantId, variantSku) {
        currentImageVariantId = variantId;
        document.getElementById('image-modal-sku').textContent = variantSku;
        document.getElementById('image-modal').style.display = 'block';
        document.getElementById('image-upload-status').textContent = '';
        loadVariantImages(variantId);
    }
    
    function closeImageModal() {
        document.getElementById('image-modal').style.display = 'none';
        currentImageVariantId = null;
        // Refresh variants to update thumbnails
        if (currentProductId) {
            loadVariants();
        }
    }
    
    function loadVariantImages(variantId) {
        const gallery = document.getElementById('image-gallery');
        gallery.innerHTML = '<span style="color:#999;">Carregando...</span>';
        
        fetch(`/catalog/bulk-edit/variants/${variantId}/images/`)
            .then(response => response.json())
            .then(data => {
                renderImageGallery(data.images || []);
            })
            .catch(error => {
                gallery.innerHTML = `<span style="color:red;">Erro: ${error}</span>`;
            });
    }
    
    function renderImageGallery(images) {
        const gallery = document.getElementById('image-gallery');
        gallery.innerHTML = '';
        
        if (images.length === 0) {
            gallery.innerHTML = '<span style="color:#999;font-style:italic;">Nenhuma imagem. Arraste imagens acima para adicionar.</span>';
            return;
        }
        
        images.forEach(img => {
            const item = document.createElement('div');
            item.className = 'image-item' + (img.is_primary ? ' primary' : '');
            
            item.innerHTML = `
                ${img.is_primary ? '<span class="primary-badge">Principal</span>' : ''}
                <img src="${img.thumbnail_url}" alt="${img.alt_text || ''}" onclick="window.open('${img.full_url}', '_blank')">
                <div class="image-actions">
                    ${!img.is_primary ? `<button onclick="setImagePrimary(${img.id})" title="Definir como principal">‚≠ê</button>` : ''}
                    <button onclick="deleteImage(${img.id})" title="Excluir">üóëÔ∏è</button>
                </div>
            `;
            
            gallery.appendChild(item);
        });
    }
    
    function uploadImages(files) {
        if (!currentImageVariantId) return;
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }
        
        const status = document.getElementById('image-upload-status');
        status.innerHTML = '<span style="color:#17a2b8;">‚è≥ Enviando...</span>';
        
        fetch(`/catalog/bulk-edit/variants/${currentImageVariantId}/images/upload/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                status.innerHTML = `<span style="color:#28a745;">‚úì ${data.uploaded} imagem(ns) enviada(s)</span>`;
                loadVariantImages(currentImageVariantId);
            } else {
                status.innerHTML = `<span style="color:#dc3545;">Erro: ${data.message}</span>`;
            }
        })
        .catch(error => {
            status.innerHTML = `<span style="color:#dc3545;">Erro: ${error}</span>`;
        });
    }
    
    function deleteImage(imageId) {
        if (!confirm('Excluir esta imagem?')) return;
        
        fetch(`/catalog/bulk-edit/images/${imageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                loadVariantImages(currentImageVariantId);
            } else {
                alert('Erro: ' + data.message);
            }
        });
    }
    
    function setImagePrimary(imageId) {
        fetch(`/catalog/bulk-edit/images/${imageId}/set-primary/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                loadVariantImages(currentImageVariantId);
            } else {
                alert('Erro: ' + data.message);
            }
        });
    }
    
    // Setup drag and drop for image upload
    function setupImageUpload() {
        const dropZone = document.getElementById('image-drop-zone');
        const fileInput = document.getElementById('image-file-input');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadImages(e.target.files);
                e.target.value = ''; // Reset input
            }
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                uploadImages(e.dataTransfer.files);
            }
        });
    }
    
    // Close modals on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            if (event.target.id === 'image-modal') {
                closeImageModal();
            }
        }
    }
    
    // Auto-generate slug from name
    document.getElementById('new-attr-type-name').addEventListener('input', function() {
        const slug = this.value.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        document.getElementById('new-attr-type-slug').value = slug;
    });
    
    // Load products on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        setupImageUpload();
    });
</script>
{% endblock %}
